{
  "name": "Shareville Discord Tracker",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Every 5 Minutes",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [100, 300]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "=[\n  { \"slug\": \"bagnis\", \"name\": \"Bagnis\", \"focus\": \"Scalping/swing\" },\n  { \"slug\": \"mingus\", \"name\": \"Mingus\", \"focus\": \"Nordic defense\" },\n  { \"slug\": \"wajme\", \"name\": \"Wajme\", \"focus\": \"Concentrated tech\" },\n  { \"slug\": \"wake76\", \"name\": \"Wake76\", \"focus\": \"Momentum\" },\n  { \"slug\": \"mahisse\", \"name\": \"Mahisse\", \"focus\": \"Long-term value\" }\n]",
        "options": {}
      },
      "id": "trader-list",
      "name": "Trader List",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [300, 300]
    },
    {
      "parameters": {
        "fieldToSplitOut": "=",
        "options": {}
      },
      "id": "split-traders",
      "name": "Split Traders",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [500, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.prod.nntech.io/shareville/v3/profiles/slug/{{ $json.slug }}",
        "options": {}
      },
      "id": "get-user-id",
      "name": "Get User ID",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://api.prod.nntech.io/shareville/v3/profiles/{{ $json.id }}/activity-feed",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "language",
              "value": "da"
            },
            {
              "name": "limit",
              "value": "50"
            }
          ]
        },
        "options": {}
      },
      "id": "get-activity-feed",
      "name": "Get Activity Feed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "// Get trader info from earlier in the chain\nconst traderInfo = $('Split Traders').first().json;\nconst slug = traderInfo.slug;\nconst traderName = traderInfo.name;\nconst traderFocus = traderInfo.focus;\n\n// Get feed data\nconst feed = $input.first().json.feed || [];\n\n// Filter for TRADE events only\nconst trades = feed.filter(event => event.type === 'TRADE');\n\n// Map trades with trader info\nreturn trades.map(trade => ({\n  json: {\n    ...trade,\n    traderSlug: slug,\n    traderName: traderName,\n    traderFocus: traderFocus\n  }\n}));"
      },
      "id": "filter-trades",
      "name": "Filter Trades",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "jsCode": "// Get workflow static data for state persistence\nconst staticData = $getWorkflowStaticData('global');\nconst lastSeen = staticData.lastSeen || {};\n\nconst trade = $input.first().json;\nconst slug = trade.traderSlug;\nconst tradeTime = new Date(trade.postedAt).getTime();\nconst tradeId = `${slug}-${trade.id || tradeTime}`;\n\n// Check if we've already seen this trade\nif (lastSeen[tradeId]) {\n  return []; // Already alerted, skip\n}\n\n// Mark as seen\nlastSeen[tradeId] = Date.now();\nstaticData.lastSeen = lastSeen;\n\n// Clean up old entries (older than 7 days)\nconst oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);\nfor (const key of Object.keys(lastSeen)) {\n  if (lastSeen[key] < oneWeekAgo) {\n    delete lastSeen[key];\n  }\n}\n\nreturn [{ json: trade }];"
      },
      "id": "check-state",
      "name": "Check If New",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v1/finance/search?q={{ encodeURIComponent($json.instrument.name) }}&quotesCount=5&newsCount=5",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "yahoo-search",
      "name": "Yahoo Finance Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1500, 300]
    },
    {
      "parameters": {
        "jsCode": "const trade = $('Check If New').first().json;\nconst yahooData = $input.first().json;\n\n// Find best matching ticker (prefer Nordic exchanges)\nconst quotes = yahooData.quotes || [];\nconst nordicExchanges = ['STO', 'CPH', 'OSL', 'HEL'];\nconst usExchanges = ['NYQ', 'NMS', 'NGM', 'NYSE', 'NASDAQ'];\n\nlet bestMatch = quotes.find(q => nordicExchanges.includes(q.exchange));\nif (!bestMatch) bestMatch = quotes.find(q => usExchanges.includes(q.exchange));\nif (!bestMatch) bestMatch = quotes[0];\n\n// Get news related to the stock\nconst news = yahooData.news || [];\nconst relatedNews = news.filter(n => {\n  const tickers = n.relatedTickers || [];\n  return bestMatch && tickers.includes(bestMatch.symbol);\n}).slice(0, 2);\n\n// If no related news, just take first news item\nconst newsToShow = relatedNews.length > 0 ? relatedNews : news.slice(0, 1);\n\nreturn [{\n  json: {\n    ...trade,\n    yahooSymbol: bestMatch?.symbol || null,\n    yahooExchange: bestMatch?.exchDisp || null,\n    sector: bestMatch?.sectorDisp || null,\n    industry: bestMatch?.industryDisp || null,\n    news: newsToShow\n  }\n}];"
      },
      "id": "process-yahoo-search",
      "name": "Process Yahoo Search",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://query1.finance.yahoo.com/v8/finance/chart/{{ $json.yahooSymbol }}?interval=1d&range=5d",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "yahoo-quote",
      "name": "Yahoo Finance Quote",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1900, 300]
    },
    {
      "parameters": {
        "jsCode": "const prevData = $('Process Yahoo Search').first().json;\nconst quoteResponse = $input.first().json;\n\n// Extract quote data\nconst meta = quoteResponse?.chart?.result?.[0]?.meta || {};\n\nreturn [{\n  json: {\n    ...prevData,\n    currentPrice: meta.regularMarketPrice,\n    fiftyTwoWeekHigh: meta.fiftyTwoWeekHigh,\n    fiftyTwoWeekLow: meta.fiftyTwoWeekLow,\n    dayHigh: meta.regularMarketDayHigh,\n    dayLow: meta.regularMarketDayLow,\n    quoteCurrency: meta.currency\n  }\n}];"
      },
      "id": "process-yahoo-quote",
      "name": "Process Yahoo Quote",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2100, 300]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\n// Colors for embed\nconst color = data.tradeType === 'BUY' ? 0x22c55e : 0xef4444; // green or red\nconst emoji = data.tradeType === 'BUY' ? 'ðŸŸ¢' : 'ðŸ”´';\nconst actionWord = data.tradeType === 'BUY' ? 'BOUGHT' : 'SOLD';\n\n// Format trade price\nconst tradePrice = data.price ? data.price.toFixed(2) : 'N/A';\nconst currency = data.currency || 'DKK';\n\n// Get instrument info\nconst instrumentName = data.instrument?.name || 'Unknown';\nconst legacyId = data.instrument?.legacyInstrumentId || '';\nconst instrumentSlug = instrumentName.toLowerCase().replace(/[^a-z0-9]+/g, '-');\nconst logoUrl = data.instrument?.logoUrl || null;\n\n// Format P&L\nconst pnl = data.percentageChange;\nconst pnlFormatted = pnl !== undefined ? `${pnl >= 0 ? '+' : ''}${pnl.toFixed(1)}%` : 'N/A';\n\n// Format date\nconst tradeDate = new Date(data.postedAt);\nconst dateStr = tradeDate.toLocaleDateString('da-DK', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });\n\n// URLs\nconst nordnetUrl = `https://www.nordnet.dk/markedet/aktiekurser/${legacyId}-${instrumentSlug}`;\nconst yahooSymbol = data.yahooSymbol || null;\nconst yahooUrl = yahooSymbol ? `https://finance.yahoo.com/quote/${yahooSymbol}` : null;\n\n// Yahoo Finance data\nconst currentPrice = data.currentPrice ? data.currentPrice.toFixed(2) : null;\nconst high52 = data.fiftyTwoWeekHigh ? data.fiftyTwoWeekHigh.toFixed(2) : null;\nconst low52 = data.fiftyTwoWeekLow ? data.fiftyTwoWeekLow.toFixed(2) : null;\n\n// Calculate 52-week position\nlet rangeInfo = null;\nif (currentPrice && high52 && low52) {\n  const range = parseFloat(high52) - parseFloat(low52);\n  if (range > 0) {\n    const pos = ((parseFloat(currentPrice) - parseFloat(low52)) / range * 100).toFixed(0);\n    const indicator = pos <= 25 ? 'ðŸ”´' : pos >= 75 ? 'ðŸŸ¢' : 'ðŸŸ¡';\n    rangeInfo = `${indicator} ${pos}% of 52W range`;\n  }\n}\n\n// Build fields array\nconst fields = [];\n\n// Row 1: Trade info\nfields.push({ name: 'ðŸ’° Trade Price', value: `${tradePrice} ${currency}`, inline: true });\nfields.push({ name: 'ðŸ“Š Position P&L', value: pnlFormatted, inline: true });\nfields.push({ name: 'ðŸ’¼ Strategy', value: data.traderFocus, inline: true });\n\n// Row 2: Market data (if available)\nif (currentPrice) {\n  fields.push({ name: 'ðŸ’µ Current Price', value: `${currentPrice} ${data.quoteCurrency || currency}`, inline: true });\n}\nif (high52 && low52) {\n  fields.push({ name: 'ðŸ“‰ 52W Range', value: `${low52} - ${high52}`, inline: true });\n}\nif (rangeInfo) {\n  fields.push({ name: 'ðŸ“ Position', value: rangeInfo, inline: true });\n}\n\n// Row 3: Sector info\nif (data.sector) {\n  fields.push({ name: 'ðŸ¢ Sector', value: data.sector, inline: true });\n}\nif (data.industry) {\n  fields.push({ name: 'ðŸ”§ Industry', value: data.industry, inline: true });\n}\nif (yahooSymbol) {\n  fields.push({ name: 'ðŸ“ˆ Ticker', value: yahooSymbol, inline: true });\n}\n\n// News section\nconst news = data.news || [];\nif (news.length > 0) {\n  const newsText = news.map(n => {\n    const title = n.title?.substring(0, 50) + (n.title?.length > 50 ? '...' : '');\n    return `â€¢ [${title}](${n.link})`;\n  }).join('\\n');\n  fields.push({ name: 'ðŸ“° Related News', value: newsText, inline: false });\n}\n\n// Build description with links\nlet description = `**${data.traderName}** ${actionWord.toLowerCase()} this stock`;\n\n// Links line\nconst links = [`[Nordnet](${nordnetUrl})`];\nif (yahooUrl) links.push(`[Yahoo Finance](${yahooUrl})`);\ndescription += `\\n\\nðŸ”— ${links.join(' â€¢ ')}`;\n\n// Build embed\nconst embed = {\n  title: `${emoji} ${actionWord}: ${instrumentName}`,\n  description: description,\n  color: color,\n  fields: fields,\n  footer: { text: `Trade executed: ${dateStr}` },\n  timestamp: data.postedAt\n};\n\n// Add thumbnail if logo available\nif (logoUrl) {\n  embed.thumbnail = { url: logoUrl };\n}\n\nreturn [{ json: { embed } }];"
      },
      "id": "format-message",
      "name": "Format Discord Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2300, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://discord.com/api/webhooks/1462271025029972116/_pntfPiYeHxMXhiNGPIow50Q2XvT5CpA2d2o8OSCm64Cu4nLt4SYKU43-Z5F3woQFfkA",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ embeds: [$json.embed] }) }}",
        "options": {}
      },
      "id": "discord-webhook",
      "name": "Send to Discord",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2500, 300]
    }
  ],
  "connections": {
    "Every 5 Minutes": {
      "main": [
        [
          {
            "node": "Trader List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trader List": {
      "main": [
        [
          {
            "node": "Split Traders",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Traders": {
      "main": [
        [
          {
            "node": "Get User ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User ID": {
      "main": [
        [
          {
            "node": "Get Activity Feed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Activity Feed": {
      "main": [
        [
          {
            "node": "Filter Trades",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter Trades": {
      "main": [
        [
          {
            "node": "Check If New",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If New": {
      "main": [
        [
          {
            "node": "Yahoo Finance Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Yahoo Finance Search": {
      "main": [
        [
          {
            "node": "Process Yahoo Search",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Yahoo Search": {
      "main": [
        [
          {
            "node": "Yahoo Finance Quote",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Yahoo Finance Quote": {
      "main": [
        [
          {
            "node": "Process Yahoo Quote",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Yahoo Quote": {
      "main": [
        [
          {
            "node": "Format Discord Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Discord Message": {
      "main": [
        [
          {
            "node": "Send to Discord",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "instanceId": "shareville-tracker"
  },
  "pinData": {},
  "versionId": "2",
  "triggerCount": 0
}
